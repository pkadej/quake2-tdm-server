#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include "g_local.h"

#ifdef TEXTURES_NAMES
unsigned char quake2_pal[768] = {
0x00,0x00,0x00,0x0f,0x0f,0x0f,0x1f,0x1f,
0x1f,0x2f,0x2f,0x2f,0x3f,0x3f,0x3f,0x4b,
0x4b,0x4b,0x5b,0x5b,0x5b,0x6b,0x6b,0x6b,
0x7b,0x7b,0x7b,0x8b,0x8b,0x8b,0x9b,0x9b,
0x9b,0xab,0xab,0xab,0xbb,0xbb,0xbb,0xcb,
0xcb,0xcb,0xdb,0xdb,0xdb,0xeb,0xeb,0xeb,
0x63,0x4b,0x23,0x5b,0x43,0x1f,0x53,0x3f,
0x1f,0x4f,0x3b,0x1b,0x47,0x37,0x1b,0x3f,
0x2f,0x17,0x3b,0x2b,0x17,0x33,0x27,0x13,
0x2f,0x23,0x13,0x2b,0x1f,0x13,0x27,0x1b,
0x0f,0x23,0x17,0x0f,0x1b,0x13,0x0b,0x17,
0x0f,0x0b,0x13,0x0f,0x07,0x0f,0x0b,0x07,
0x5f,0x5f,0x6f,0x5b,0x5b,0x67,0x5b,0x53,
0x5f,0x57,0x4f,0x5b,0x53,0x4b,0x53,0x4f,
0x47,0x4b,0x47,0x3f,0x43,0x3f,0x3b,0x3b,
0x3b,0x37,0x37,0x33,0x2f,0x2f,0x2f,0x2b,
0x2b,0x27,0x27,0x27,0x23,0x23,0x23,0x1b,
0x1b,0x1b,0x17,0x17,0x17,0x13,0x13,0x13,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0xeb,0x9f,0x27,0xcb,0x8b,0x23,0xaf,0x77,
0x1f,0x93,0x63,0x1b,0x77,0x4f,0x17,0x5b,
0x3b,0x0f,0x3f,0x27,0x0b,0x23,0x17,0x07,
0xa7,0x3b,0x2b,0x9f,0x2f,0x23,0x97,0x2b,
0x1b,0x8b,0x27,0x13,0x7f,0x1f,0x0f,0x73,
0x17,0x0b,0x67,0x17,0x07,0x57,0x13,0x00,
0x4b,0x0f,0x00,0x43,0x0f,0x00,0x3b,0x0f,
0x00,0x33,0x0b,0x00,0x2b,0x0b,0x00,0x23,
0x0b,0x00,0x1b,0x07,0x00,0x13,0x07,0x00,
0x7b,0x5f,0x4b,0x73,0x57,0x43,0x6b,0x53,
0x3f,0x67,0x4f,0x3b,0x5f,0x47,0x37,0x57,
0x43,0x33,0x53,0x3f,0x2f,0x4b,0x37,0x2b,
0x43,0x33,0x27,0x3f,0x2f,0x23,0x37,0x27,
0x1b,0x2f,0x23,0x17,0x27,0x1b,0x13,0x1f,
0x17,0x0f,0x17,0x0f,0x0b,0x0f,0x0b,0x07,
0x6f,0x3b,0x17,0x5f,0x37,0x17,0x53,0x2f,
0x17,0x43,0x2b,0x17,0x37,0x23,0x13,0x27,
0x1b,0x0f,0x1b,0x13,0x0b,0x0f,0x0b,0x07,
0xb3,0x5b,0x4f,0xbf,0x7b,0x6f,0xcb,0x9b,
0x93,0xd7,0xbb,0xb7,0xcb,0xd7,0xdf,0xb3,
0xc7,0xd3,0x9f,0xb7,0xc3,0x87,0xa7,0xb7,
0x73,0x97,0xa7,0x5b,0x87,0x9b,0x47,0x77,
0x8b,0x2f,0x67,0x7f,0x17,0x53,0x6f,0x13,
0x4b,0x67,0x0f,0x43,0x5b,0x0b,0x3f,0x53,
0x07,0x37,0x4b,0x07,0x2f,0x3f,0x07,0x27,
0x33,0x00,0x1f,0x2b,0x00,0x17,0x1f,0x00,
0x0f,0x13,0x00,0x07,0x0b,0x00,0x00,0x00,
0x8b,0x57,0x57,0x83,0x4f,0x4f,0x7b,0x47,
0x47,0x73,0x43,0x43,0x6b,0x3b,0x3b,0x63,
0x33,0x33,0x5b,0x2f,0x2f,0x57,0x2b,0x2b,
0x4b,0x23,0x23,0x3f,0x1f,0x1f,0x33,0x1b,
0x1b,0x2b,0x13,0x13,0x1f,0x0f,0x0f,0x13,
0x0b,0x0b,0x0b,0x07,0x07,0x00,0x00,0x00,
0x97,0x9f,0x7b,0x8f,0x97,0x73,0x87,0x8b,
0x6b,0x7f,0x83,0x63,0x77,0x7b,0x5f,0x73,
0x73,0x57,0x6b,0x6b,0x4f,0x63,0x63,0x47,
0x5b,0x5b,0x43,0x4f,0x4f,0x3b,0x43,0x43,
0x33,0x37,0x37,0x2b,0x2f,0x2f,0x23,0x23,
0x23,0x1b,0x17,0x17,0x13,0x0f,0x0f,0x0b,
0x9f,0x4b,0x3f,0x93,0x43,0x37,0x8b,0x3b,
0x2f,0x7f,0x37,0x27,0x77,0x2f,0x23,0x6b,
0x2b,0x1b,0x63,0x23,0x17,0x57,0x1f,0x13,
0x4f,0x1b,0x0f,0x43,0x17,0x0b,0x37,0x13,
0x0b,0x2b,0x0f,0x07,0x1f,0x0b,0x07,0x17,
0x07,0x00,0x0b,0x00,0x00,0x00,0x00,0x00,
0x77,0x7b,0xcf,0x6f,0x73,0xc3,0x67,0x6b,
0xb7,0x63,0x63,0xa7,0x5b,0x5b,0x9b,0x53,
0x57,0x8f,0x4b,0x4f,0x7f,0x47,0x47,0x73,
0x3f,0x3f,0x67,0x37,0x37,0x57,0x2f,0x2f,
0x4b,0x27,0x27,0x3f,0x23,0x1f,0x2f,0x1b,
0x17,0x23,0x13,0x0f,0x17,0x0b,0x07,0x07,
0x9b,0xab,0x7b,0x8f,0x9f,0x6f,0x87,0x97,
0x63,0x7b,0x8b,0x57,0x73,0x83,0x4b,0x67,
0x77,0x43,0x5f,0x6f,0x3b,0x57,0x67,0x33,
0x4b,0x5b,0x27,0x3f,0x4f,0x1b,0x37,0x43,
0x13,0x2f,0x3b,0x0b,0x23,0x2f,0x07,0x1b,
0x23,0x00,0x13,0x17,0x00,0x0b,0x0f,0x00,
0x00,0xff,0x00,0x23,0xe7,0x0f,0x3f,0xd3,
0x1b,0x53,0xbb,0x27,0x5f,0xa7,0x2f,0x5f,
0x8f,0x33,0x5f,0x7b,0x33,0xff,0xff,0xff,
0xff,0xff,0xd3,0xff,0xff,0xa7,0xff,0xff,
0x7f,0xff,0xff,0x53,0xff,0xff,0x27,0xff,
0xeb,0x1f,0xff,0xd7,0x17,0xff,0xbf,0x0f,
0xff,0xab,0x07,0xff,0x93,0x00,0xef,0x7f,
0x00,0xe3,0x6b,0x00,0xd3,0x57,0x00,0xc7,
0x47,0x00,0xb7,0x3b,0x00,0xab,0x2b,0x00,
0x9b,0x1f,0x00,0x8f,0x17,0x00,0x7f,0x0f,
0x00,0x73,0x07,0x00,0x5f,0x00,0x00,0x47,
0x00,0x00,0x2f,0x00,0x00,0x1b,0x00,0x00,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,
0x00,0x00,0x00,0xff,0x2b,0x2b,0x23,0x1b,
0x1b,0x17,0x13,0x13,0x0f,0xeb,0x97,0x7f,
0xc3,0x73,0x53,0x9f,0x57,0x33,0x7b,0x3f,
0x1b,0xeb,0xd3,0xc7,0xc7,0xab,0x9b,0xa7,
0x8b,0x77,0x87,0x6b,0x57,0x9f,0x5b,0x53
};

void Cmd_Convert_f(edict_t *ent)
{
	vec3_t	start, forward, end;
	trace_t tr;
	cvar_t	*basedir, *gamedir;
	char	outf[256];
	char	inf[256];
	FILE	*f=NULL;

	VectorCopy(ent->s.origin, start);
	start[2] += ent->viewheight;
	AngleVectors(ent->client->v_angle, forward, NULL, NULL);
	VectorMA(start, 8192, forward, end);
	tr = gi.trace(start, NULL, NULL, end, ent, MASK_SHOT);

	if (strlen(tr.surface->name))
	{
		basedir = gi.cvar("basedir", "", 0);
		gamedir = gi.cvar("gamedir", "", 0);

		strcpy(outf,basedir->string);
		strcpy(inf,basedir->string);
		strcat(inf,"/baseq2/textures/");
		strcat(inf, tr.surface->name);
		strcat(inf, ".wal");

		if(strlen(gamedir->string))
		{
			strcat(outf,"/");
			strcat(outf,gamedir->string);
			strcat(outf,"/");
			strcat(outf,"textures/");
		}
		else
			strcat(outf,"/baseq2/textures/");
		strcat(outf, tr.surface->name);
		strcat(outf, ".pcx");
	}
	else
	{
		gi.cprintf(ent, PRINT_HIGH, "Noting to convert!\n");
		return;
	}

	f = fopen(inf,"rb");

	if(!f)
	{
		gi.cprintf(ent, PRINT_HIGH, "Couldn't find file %s!\n", inf);
		return;
	}
	else
	{
		int fsize, mips_size, width,height, i, j, mipsize, expected_size;
		char walname[32];
		int  mip_offs[4];
		unsigned char *mip;
		short w,h,bytesperline;

	    fseek(f,0,SEEK_END);
		fsize = ftell(f);
		fseek(f,0,SEEK_SET);

		fread(walname,32,1,f);
  
		fread(&width,1,sizeof(int),f);
		fread(&height,1,sizeof(int),f);

		fread(&mip_offs,4,sizeof(int),f);

		mips_size = (width*height) + (width*height/4) + (width*height/16) + (width*height/64);
		expected_size = mip_offs[0] + mips_size;

		if ((fsize == expected_size) && (fsize >= 56+mips_size))
		{
			mipsize = width*height;

			mip = malloc (mipsize);

			fseek(f,mip_offs[0],SEEK_SET);
			fread(mip,mipsize,1,f);
			fclose(f);
	    }
		else
		{
			gi.cprintf(ent, PRINT_HIGH, "Corupted .wal file!\n");
			fclose(f);
			return;
		}

		f = fopen(outf,"wb");

		if(!f)
		{
			gi.cprintf(ent, PRINT_HIGH, "Couldn't create output file!\n");
			return;
		}

		gi.cprintf(ent, PRINT_HIGH, "Writing .pcx file -> %s\n",outf);

		w = width-1;
		h = height-1;
		bytesperline = width;

		//hardcoded 8 bit uncompressed .pcx writer
		fputc(0x0A,f);
		fputc(0x05,f);
		fputc(0x01,f);
		fputc(0x08,f);
		fputc(0x00,f);
		fputc(0x00,f);
		fputc(0x00,f);
		fputc(0x00,f);

		fwrite(&w,sizeof(short),1,f);
		fwrite(&h,sizeof(short),1,f);

		fputc(0x00,f);
		fputc(0x96,f);
		fputc(0x00,f);
		fputc(0x96,f);

		for(i=0; i<48; i++)
			fputc(0x00,f);

		fputc(0x00,f);
		fputc(0x01,f);
		fwrite(&bytesperline,sizeof(short),1,f);
		fputc(0x02,f);

		for(i=0; i<59; i++)
			fputc(0x00,f);

		for(i=0; i<height; i++)
		{
			for(j=0; j<width; j++)
			{
				fputc(0xC1,f);
				fputc(mip[i*width+j],f);
			}
		}
		fputc(12,f);
	
		//write the palette
		fwrite(quake2_pal,768,1,f);
		fclose(f);
	}
}
#endif